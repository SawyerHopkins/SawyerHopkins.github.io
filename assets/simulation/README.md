This is a really brutal port of my C++ code to Javascript and is far from optimized.