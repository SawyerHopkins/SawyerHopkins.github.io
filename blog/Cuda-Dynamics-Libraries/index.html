<!DOCTYPE HTML>
<!--
	Prologue 1.1 by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" href="/favicon.ico">

	<title>Dynamic Libraries in CUDA</title>
	
<!-- Google Analytics -->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54925912-1', 'auto');
  ga('send', 'pageview');

	</script>
	
<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

	<script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
	
<!-- Latest compiled and minified JavaScript -->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	
<!-- FontAwesome -->
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
<!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
	<script src="/assets/js/ie-emulation-modes-warning.js"></script>

	<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
 <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Custom styles for this template -->
	<link href="/assets/css/carousel.css" rel="stylesheet">
	<link href="/assets/css/catagories.css" rel="stylesheet">
	<link href="/assets/css/general.css" rel="stylesheet">
	<link href="/assets/css/gist.css" rel="stylesheet">
	<link href="/assets/css/feature.css" rel="stylesheet">
	<link href="/assets/css/navbar.css" rel="stylesheet">
	<link href="/assets/css/post.css" rel="stylesheet">
	<link href="/assets/css/page.css" rel="stylesheet">
	<link href="/assets/css/pagination.css" rel="stylesheet">
	<link href="/assets/css/social.css" rel="stylesheet">
	<link href="/assets/css/syntax.css" rel="stylesheet">
	<link href="/assets/css/wells.css" rel="stylesheet">
 </head>
	<body>
		<!-- NAVBAR
================================================== -->
<body>
	<div class="navbar-wrapper">
		<div class="container">		
			<div class="navbar navbar-inverse navbar-static-top" role="navigation">
				<div class="container">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="/">
						<img class="img-grav" src="/assets/img/profile.jpg" alt="A picture of me.">  
						Sawyer Hopkins </a>
					</div>
					<div class="navbar-collapse collapse">
						<ul class="nav navbar-nav">
							
								<li><a href="/">Home</a></li>
								<li class="dropdown active">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown"> Blog <span class="caret"></span></a>
								<ul class="dropdown-menu" role="menu">
									<li><a href="/blog/">Recent</a></li>
									<li class="divider"></li>
									<li><a href="/categories/">Categories</a></li>
								</ul>
								</li>
							
						</ul>
						<ul class="nav navbar-nav iconnav">
							<li class="icon-row"><a href="https://www.facebook.com/sshopkin" class="icon-link"><i class="fa fa-facebook-square social"></i></a></li>
							<li class="icon-row"><a href="https://www.linkedin.com/in/sawyerhopkins" class="icon-link"><i class="fa fa-linkedin-square social"></i></a></li>
							<li class="icon-row"><a href="https://github.com/SawyerHopkins" class="icon-link"><i class="fa fa-github-square social"></i></a></li>
							<li class="icon-row"><a href="mailto:sawyer@sawyerhopkins.com" class="icon-link"><i class="fa fa-envelope-square social"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
		    <!-- Carousel
    ================================================== -->
    <div id="myCarousel" class="carousel slide" data-ride="carousel">
      <div class="carousel-inner" role="listbox" style="background: url(/assets/img/sawyerheader.jpg) no-repeat top center fixed">
	  	
		<div class="item active">		
		

          <!--<img src="/assets/img/sawyerheader.png" class="img-responsive">-->
          <div class="container">
            <div class="carousel-caption">
              <h1><b><span class="carousel-text">Dynamic Libraries in CUDA</span></b></h1>
              <p><span class="carousel-text">How to load CUDA dependant dynamically libraries.</span></p>
            </div>
          </div>
        </div>		
		
	</div>	
    </div><!-- /.carousel -->
		<!-- Main -->
		<div id="main">
			<div class="well well-depth-1 post-body">
				<div class="post-block">
			    	<div class="well well-depth-2">
			    	<p class="post-header">Building the dynamic library.</p>
	
<p class="post-para">So we need to look at two pieces of code: Some class that inherits an abstract class that is to be seperatedly compiled and loaded as the dynamic library, and some main application the we want to load this library into. Normally this is a straight forward process, but since copying objects directly to device memory does not make a copy of the VTable we will need to add an extra step along the way.</p>
	
<!--more-->		

<p class="post-para">So here is our class to be loaded. Here I have included a standard constructor and some work function. Notice these are all flagged with device, so we are looking to offload these functions.</p>

<figure>
<figcaption><b>myClass.cpp</b></figcaption>
<div class="post-para">
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="lineno">1</span> <span class="k">class</span> <span class="nc">DynamicClass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">LoaderClass</span>
<span class="lineno">2</span> <span class="p">{</span>
<span class="lineno">3</span> 	<span class="k">public</span><span class="o">:</span>
<span class="lineno">4</span> 		<span class="n">__device__</span>
<span class="lineno">5</span> 		<span class="n">DynamicClass</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">vars</span><span class="p">);</span>
<span class="lineno">6</span> 		<span class="n">__device__</span>
<span class="lineno">7</span> 		<span class="kt">void</span> <span class="nf">cudaTest</span><span class="p">();</span>
<span class="lineno">8</span> <span class="p">};</span></code></pre></div>
</div>
</figure>

<p class="post-para">This is the class we want load. Here I have included a constructor and some work function. Notice these are both flagged with device, so we are looking to offload these functions. The next step is to make the factories to create and interact with this class. Since we want to run these functions on the device we need to instantiate the class on device. By doing this the VTable will be created on the device as well, and we won't get a slew of runtime errors.</p>

<figure>
<figcaption><b>myClass.cpp</b></figcaption>
<div class="post-para">
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="lineno"> 1</span> <span class="n">__global__</span>
<span class="lineno"> 2</span> <span class="kt">void</span> <span class="nf">buildKernel</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span> <span class="n">myClass</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">vars</span><span class="p">)</span>
<span class="lineno"> 3</span> <span class="p">{</span>
<span class="lineno"> 4</span> <span class="p">(</span><span class="o">*</span><span class="n">myClass</span><span class="p">)</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DynamicClass</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
<span class="lineno"> 5</span> <span class="p">}</span>
<span class="lineno"> 6</span> 
<span class="lineno"> 7</span> <span class="n">__global__</span>
<span class="lineno"> 8</span> <span class="kt">void</span> <span class="nf">testKernel</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span> <span class="n">myClass</span><span class="p">)</span>
<span class="lineno"> 9</span> <span class="p">{</span>
<span class="lineno">10</span> <span class="p">(</span><span class="o">*</span><span class="n">myClass</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cudaTest</span><span class="p">();</span>
<span class="lineno">11</span> <span class="p">}</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="c1">//Class factories.</span>
<span class="lineno">14</span> <span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">getCudaClass</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span> <span class="n">myClass</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">vars</span><span class="p">)</span>
<span class="lineno">15</span> <span class="p">{</span>
<span class="lineno">16</span> <span class="n">buildKernel</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">myClass</span><span class="p">,</span><span class="n">vars</span><span class="p">);</span>
<span class="lineno">17</span> <span class="n">cudaDeviceSynchronize</span><span class="p">();</span>
<span class="lineno">18</span> <span class="p">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">runCudaTest</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span> <span class="n">myClass</span><span class="p">)</span>
<span class="lineno">21</span> <span class="p">{</span>
<span class="lineno">22</span> <span class="n">testKernel</span><span class="o">&lt;&lt;&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">myClass</span><span class="p">);</span>
<span class="lineno">23</span> <span class="n">cudaDeviceSynchronize</span><span class="p">();</span>
<span class="lineno">24</span> <span class="p">}</span></code></pre></div>
</div>
</figure>

<p class="post-header">Creating the interface.</p>

<p class="post-para">Note you can change the kernels for work functions to launch with any number of allowable blocks and threads; we really only need the class constructor to be run on one thread. Now we need to create the abstract class which we will use to interface with the class we are loading.</p>

<figure>
<figcaption><b>LoaderClass.h</b></figcaption>
<div class="post-para">
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="lineno"> 1</span> <span class="k">class</span> <span class="nc">LoaderClass</span>
<span class="lineno"> 2</span> <span class="p">{</span>
<span class="lineno"> 3</span> <span class="k">public</span><span class="o">:</span>
<span class="lineno"> 4</span> 	<span class="n">__device__</span>
<span class="lineno"> 5</span> 	<span class="k">virtual</span> <span class="kt">void</span> <span class="n">cudaTest</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="lineno"> 6</span> <span class="p">};</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span> <span class="cm">/** Typedef the factories */</span>
<span class="lineno"> 9</span> <span class="k">typedef</span> <span class="kt">void</span> <span class="nf">createCudaClass</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="p">);</span>
<span class="lineno">10</span> <span class="k">typedef</span> <span class="kt">void</span> <span class="nf">cudaTest</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span><span class="p">);</span></code></pre></div>
</div>
</figure>

<p class="post-header">Putting it all.</p>

<p class="post-para">Now that we have all the building blocks setup we can work on the main application. Since the factories we created will spin off the kernels for us we can use dlopen as we would with any other dynamically loaded library with one caveat. Since our constructor is looking for a float array, we should pass it a pointer to an array that exists on device. We do this by created the array on the host machine and then copying it over with cudaMemcpy.</p>

<figure>
<figcaption><b>main.cpp</b></figcaption>
<div class="post-para">
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="lineno"> 1</span> <span class="kt">void</span><span class="o">*</span> <span class="n">myLib</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="s">&quot;myClass.so&quot;</span><span class="p">,</span> <span class="n">RTLD_LAZY</span><span class="p">);</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="c1">//Throw error if the library does not exist.</span>
<span class="lineno"> 4</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">myLib</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 5</span> 	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Error loading the library.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="lineno"> 6</span> 	<span class="k">return</span><span class="p">;</span>
<span class="lineno"> 7</span> <span class="p">}</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="n">dlerror</span><span class="p">();</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="c1">//Make a factory to create the class instance.</span>
<span class="lineno">12</span> <span class="n">createCudaClass</span><span class="o">*</span> <span class="n">buildFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">createCudaClass</span><span class="o">*</span><span class="p">)</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">myLib</span><span class="p">,</span><span class="s">&quot;getCudaClass&quot;</span><span class="p">);</span>
<span class="lineno">13</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<span class="lineno">14</span> 
<span class="lineno">15</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">16</span> 	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Could not find symbol: getCudaClass</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="lineno">17</span> 	<span class="k">return</span><span class="p">;</span>
<span class="lineno">18</span> <span class="p">}</span>
<span class="lineno">19</span> 
<span class="lineno">20</span> <span class="c1">//Setup variables to copy.</span>
<span class="lineno">21</span> <span class="kt">float</span> <span class="n">hostFoo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>
<span class="lineno">22</span> <span class="kt">float</span><span class="o">*</span> <span class="n">deviceFoo</span><span class="p">;</span>
<span class="lineno">23</span> <span class="kt">int</span> <span class="n">fooSize</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
<span class="lineno">24</span> <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">deviceFoo</span><span class="p">,</span> <span class="n">fooSize</span><span class="p">);</span>
<span class="lineno">25</span> <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">deviceFoo</span><span class="p">,</span><span class="n">hostFoo</span><span class="p">,</span><span class="n">fooSize</span><span class="p">,</span><span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="lineno">28</span> 
<span class="lineno">29</span> <span class="c1">//Create a new class instance from the factory.</span>
<span class="lineno">30</span> <span class="n">LoaderClass</span><span class="o">**</span> <span class="n">loadClass</span><span class="p">;</span>
<span class="lineno">31</span> <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loadClass</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LoaderClass</span><span class="o">**</span><span class="p">));</span>
<span class="lineno">32</span> <span class="n">buildFactory</span><span class="p">(</span><span class="n">loadClass</span><span class="p">,</span> <span class="n">deviceFoo</span><span class="p">);</span>
<span class="lineno">33</span> 
<span class="lineno">34</span> <span class="c1">//Make the work function factory.</span>
<span class="lineno">35</span> <span class="n">cudaTest</span><span class="o">*</span> <span class="n">testFactory</span> <span class="o">=</span> <span class="p">(</span><span class="n">cudaTest</span><span class="o">*</span><span class="p">)</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">myLib</span><span class="p">,</span><span class="s">&quot;runCudaTest&quot;</span><span class="p">);</span>
<span class="lineno">36</span> 
<span class="lineno">37</span> <span class="n">err</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<span class="lineno">38</span> 
<span class="lineno">39</span> <span class="c1">//If the force is not properly implemented.</span>
<span class="lineno">40</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="lineno">41</span> <span class="p">{</span>
<span class="lineno">42</span> 	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Could not find symbol: runCudaTest</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="lineno">43</span> 	<span class="k">return</span><span class="p">;</span>
<span class="lineno">44</span> <span class="p">}</span></code></pre></div>
</div>
</figure>

<p class="post-para">Now we can the run work function on device. If you are looking to spin off multiple kernels note that the <i>cudaDeviceSynchronize</i> function is included in the factories and should be removed if needed.</p>

<figure>
<figcaption><b>main.cpp</b></figcaption>
<div class="post-para">
<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="lineno">1</span> <span class="n">testFactory</span><span class="p">(</span><span class="n">loadClass</span><span class="p">);</span></code></pre></div>
</div>
</figure>
			    	</div>
					<div class="gist-link">
					  
					</div>

				<div class="social-sharing">
	
	<div class="share-button text">
	Share
	</div>
	<div class="share-button twitter">
		<a href="https://twitter.com/home?status=/blog/Cuda-Dynamics-Libraries " target="_blank"><i class="fa fa-twitter social"></i></a>
	</div>
	<div class="share-button linkedin">
		<a href="http://www.linkedin.com/shareArticle?mini=true&url=/blog/Cuda-Dynamics-Libraries&title=Dynamic Libraries in CUDA&summary=How to load CUDA dependant dynamically libraries.&source=SawyerHopkins.com" target="_blank"><i class="fa fa-linkedin social"></i></a>
	</div>
	<div class="share-button gplus">
		<a href="https://plus.google.com/share?url=/blog/Cuda-Dynamics-Libraries" target="_blank"><i class="fa fa-google-plus social"></i></a>
	</div>
	
</div>
				  
				
					<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'sawyerhopkins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
     
				
				</div>
			</div>
		</div>
		
	</body>
</html>